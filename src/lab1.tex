% ============================================================
% Lab 1: Làm quen với TIA Portal và thiết kế HMI
% ============================================================

\setcounter{section}{1}
\setcounter{subsection}{0}
\section*{BÀI THÍ NGHIỆM 1: ĐO NHIỆT ĐỘ}
\addcontentsline{toc}{section}{Bài thí nghiệm 1: Đo nhiệt độ}

% ------------------------------------------------------------
\subsection{Mục tiêu}
% ------------------------------------------------------------

\begin{itemize}
    \item Làm quen với phần mềm TIA Portal V16 và cách tạo project mới.
    \item Cấu hình PLC S7-1200 và kết nối với cảm biến nhiệt độ.
    \item Thiết kế giao diện HMI để hiển thị giá trị nhiệt độ đo được.
\end{itemize}

% ------------------------------------------------------------
\subsection{Cơ sở lý thuyết}
% ------------------------------------------------------------

\subsubsection{Giới thiệu TIA Portal}

TIA Portal (Totally Integrated Automation Portal) là nền tảng phần mềm tích hợp của Siemens, cho phép cấu hình, lập trình và giám sát các thiết bị tự động hóa như PLC, HMI, và drive trong một môi trường thống nhất.

Các thành phần chính của TIA Portal:
\begin{itemize}
    \item \textbf{STEP 7:} Lập trình PLC (LAD, FBD, SCL, STL)
    \item \textbf{WinCC:} Thiết kế giao diện HMI/SCADA
\end{itemize}

\subsubsection{PLC Siemens S7-1200}

S7-1200 là dòng PLC compact của Siemens, phù hợp cho các ứng dụng tự động hóa vừa và nhỏ. Đặc điểm:
\begin{itemize}
    \item CPU tích hợp các cổng I/O số và analog
    \item Hỗ trợ giao tiếp PROFINET (Ethernet)
    \item Có thể mở rộng thêm module I/O, truyền thông
\end{itemize}

\subsubsection{Giao diện HMI}

HMI (Human-Machine Interface) là giao diện giữa người vận hành và hệ thống điều khiển. Trong TIA Portal, WinCC cho phép thiết kế các màn hình hiển thị với:
\begin{itemize}
    \item Hiển thị giá trị biến (số, đồ thị, gauge)
    \item Nút nhấn, công tắc điều khiển
    \item Cảnh báo và báo động (alarm)
\end{itemize}

% ------------------------------------------------------------
\subsection{Thiết bị thí nghiệm}
% ------------------------------------------------------------

\begin{itemize}
    \item Máy tính cài đặt TIA Portal V16
    \item PLC Siemens S7-1200 CPU 1213C
    \item Cảm biến nhiệt độ
    \item Kết nối WiFi giữa PLC và máy tính
\end{itemize}

% ------------------------------------------------------------
\subsection{Quy trình thực hiện}
% ------------------------------------------------------------

\subsubsection{Tạo project mới trong TIA Portal}
\begin{enumerate}
    \item Mở TIA Portal V16, chọn \texttt{Create new project}.
    \item Đặt tên project và chọn đường dẫn lưu trữ.
    \item Chọn \texttt{Configure a device} để thêm PLC.
\end{enumerate}

\subsubsection{Cấu hình PLC S7-1200}
\begin{enumerate}
    \item Thêm PLC S7-1200 CPU 1213C DC/DC/DC vào project.
    \item Cấu hình địa chỉ IP cho PLC (ví dụ: 192.168.0.1).
    \item Tạo tag cho biến nhiệt độ (PV - Process Value).
\end{enumerate}

\subsubsection{Thiết kế giao diện HMI}
\begin{enumerate}
    \item Thêm HMI mô phỏng (WinCC RT Advanced) vào project.
    \item Tạo màn hình hiển thị với các thành phần:
    \begin{itemize}
        \item Text hiển thị tiêu đề
        \item I/O Field hiển thị giá trị nhiệt độ (liên kết với tag PV)
        \item Trend graph để theo dõi biến thiên nhiệt độ theo thời gian
        \item Đơn vị đo (°C)
    \end{itemize}
    \item Cấu hình Historical Data để ghi lại dữ liệu đo được (dùng để vẽ đồ thị trong báo cáo).
    \item Cấu hình kết nối HMI với PLC qua PROFINET.
\end{enumerate}

\subsubsection{Download và kiểm tra}
\begin{enumerate}
    \item Compile project để kiểm tra lỗi.
    \item Download chương trình xuống PLC.
    \item Chạy WinCC RT trên máy tính và quan sát giá trị nhiệt độ hiển thị.
\end{enumerate}

% ------------------------------------------------------------
\subsection{Kết quả thí nghiệm}
% ------------------------------------------------------------

\subsubsection{Giao diện HMI}

\begin{figure}[H]
\centering
\includegraphics[width=0.8\textwidth]{../assets/HMI_TN1.jpg}
\caption{Giao diện HMI hiển thị giá trị nhiệt độ đo được}
\label{fig:hmi_tn1}
\end{figure}

Giao diện HMI được thiết kế với các thành phần:
\begin{itemize}
    \item Hiển thị giá trị nhiệt độ hiện tại (PV) từ cảm biến
    \item Trend graph theo dõi biến thiên nhiệt độ theo thời gian
    \item Historical Data ghi lại dữ liệu để xuất ra file CSV
    \item Đơn vị đo: °C
\end{itemize}

\subsubsection{Kết quả đo nhiệt độ}

Tiến hành đo nhiệt độ môi trường trong 2 phút để kiểm tra hoạt động của hệ thống.

\begin{figure}[H]
\centering
\begin{tikzpicture}
\begin{axis}[
    width=0.9\textwidth,
    height=6cm,
    xlabel={Thời gian (s)},
    ylabel={Nhiệt độ ($^\circ$C)},
    grid=both,
    grid style={line width=.1pt, draw=gray!30},
    major grid style={line width=.2pt,draw=gray!50},
    xmin=0, xmax=130,
    ymin=25.0, ymax=25.5,
    legend pos=north east,
]
\addplot[blue, thick, mark=*, mark size=1pt] table[x=time_s, y=PV, col sep=comma] {../data/TN1_processed.csv};
\addlegendentry{Nhiệt độ đo được}
\addplot[red, dashed, domain=0:130] {25.304};
\addlegendentry{Giá trị trung bình = $25.30^\circ$C}
\end{axis}
\end{tikzpicture}
\caption{Kết quả đo nhiệt độ môi trường}
\label{fig:tn1_result}
\end{figure}

\textbf{Kết quả:}
\begin{itemize}
    \item Nhiệt độ trung bình: $25.30^\circ$C
    \item Dải dao động: $25.30 - 25.32^\circ$C
    \item Hệ thống hoạt động ổn định, giá trị hiển thị chính xác trên HMI
\end{itemize}

% ------------------------------------------------------------
\subsection{Bàn luận}
% ------------------------------------------------------------

\begin{itemize}
    \item TIA Portal cung cấp môi trường tích hợp thuận tiện cho việc cấu hình PLC và thiết kế HMI.
    \item Việc kết nối giữa HMI và PLC qua PROFINET đơn giản, chỉ cần cấu hình địa chỉ IP và liên kết tag.
    \item Giao diện HMI cho phép giám sát giá trị nhiệt độ theo thời gian thực.
    \item Dữ liệu đo được có thể ghi lại (logging) để phân tích sau này.
\end{itemize}

% ------------------------------------------------------------
\subsection{Kết luận}
% ------------------------------------------------------------

Qua bài thí nghiệm, đã thực hiện được:

\begin{enumerate}
    \item Tạo project mới trong TIA Portal V16 và cấu hình PLC S7-1200.
    \item Thiết kế giao diện HMI để hiển thị giá trị nhiệt độ từ cảm biến.
    \item Kiểm tra hoạt động của hệ thống với kết quả đo nhiệt độ môi trường ổn định tại $25.30^\circ$C.
\end{enumerate}

% ------------------------------------------------------------
\subsection{Câu hỏi kiểm tra}
% ------------------------------------------------------------

\textbf{Câu 1: Cảm biến đang sử dụng trong bài thí nghiệm là cảm biến loại 2 chân, 3 chân hay 4 chân? Vẽ sơ đồ kết nối cảm biến vào CPU.}

Cảm biến nhiệt độ sử dụng trong bài thí nghiệm có 3 chân, nhưng chỉ sử dụng 2 chân để kết nối với CPU.

\begin{figure}[H]
\centering
\begin{tikzpicture}[node distance=2cm]
    % Sensor
    \node[draw, rectangle, minimum width=2cm, minimum height=1.5cm] (sensor) {Cảm biến nhiệt độ};
    
    % PLC
    \node[draw, rectangle, minimum width=3cm, minimum height=2cm, right=3cm of sensor, align=center] (plc) {PLC S7-1200\\CPU 1213C};
    
    % Analog input module label
    \node[font=\small, above=0.3cm of plc] {Analog Input};
    
    % Connections
    \draw[thick] (sensor.east) ++(0,0.3) -- ++(1,0) node[midway, above, font=\small] {AI+} -- ++(0.5,0) |- ([yshift=0.3cm]plc.west);
    \draw[thick] (sensor.east) ++(0,-0.3) -- ++(1,0) node[midway, below, font=\small] {AI-} -- ++(0.5,0) |- ([yshift=-0.3cm]plc.west);
    
    % Third pin (unused)
    \draw[thick, dashed, gray] (sensor.south) -- ++(0,-0.5) node[below, font=\small] {Chân 3 (không sử dụng)};
    
\end{tikzpicture}
\caption{Sơ đồ kết nối cảm biến nhiệt độ với CPU}
\label{fig:sensor_connection}
\end{figure}

\textbf{Câu 2: Viết sơ đồ khối điều khiển cho điều khiển nhiệt độ ở thiết bị sấy đối lưu.}

\begin{figure}[H]
\centering
\begin{tikzpicture}[node distance=1.8cm]
    % Setpoint
    \node (sp) {SP};
    
    % Sum
    \node[sum, right=1cm of sp] (sum) {};
    
    % Controller
    \node[block, right=1.2cm of sum] (controller) {Bộ điều khiển};
    
    % Actuator
    \node[block, right=1.2cm of controller] (actuator) {Heater};
    
    % Process
    \node[block, right=1.2cm of actuator] (process) {Buồng sấy};
    
    % Output
    \node[right=1cm of process] (output) {$T$};
    
    % Sensor
    \node[block, below=1cm of process] (sensor) {Cảm biến nhiệt độ};
    
    % Arrows
    \draw[arrow] (sp) -- (sum);
    \draw[arrow] (sum) -- node[above, font=\small] {$e$} (controller);
    \draw[arrow] (controller) -- node[above, font=\small] {$u$} (actuator);
    \draw[arrow] (actuator) -- node[above, font=\small] {$Q$} (process);
    \draw[arrow] (process) -- (output);
    
    % Feedback
    \coordinate (fb) at ($(process.east)!0.5!(output.west)$);
    \draw[line] (fb) |- (sensor);
    \draw[arrow] (sensor) -| (sum) node[pos=0.9, left, font=\small] {$-$};
    
    % Sum signs
    \node[font=\scriptsize] at ($(sum.north)+(0.15,0)$) {$+$};
    
\end{tikzpicture}
\caption{Sơ đồ khối điều khiển nhiệt độ thiết bị sấy đối lưu}
\label{fig:temp_control_block}
\end{figure}

Trong đó:
\begin{itemize}
    \item SP: Giá trị đặt nhiệt độ mong muốn
    \item $e$: Sai lệch ($e = \text{SP} - \text{PV}$)
    \item $u$: Tín hiệu điều khiển
    \item $Q$: Công suất nhiệt cấp vào buồng sấy
    \item $T$: Nhiệt độ thực tế trong buồng sấy
    \item Cảm biến nhiệt độ: Đo nhiệt độ thực tế và phản hồi về bộ điều khiển
\end{itemize}

% ------------------------------------------------------------
\subsection{Tài liệu tham khảo}
% ------------------------------------------------------------

\begin{enumerate}[label={[\arabic*]}]
    \item B. N. Pha, \textit{Thiết bị Đo lường và Điều khiển}. Trường Đại học Bách khoa, ĐHQG-HCM.
    \item Siemens, \textit{S7-1200 Programmable Controller System Manual}. Siemens AG, 2020.
\end{enumerate}

\newpage
