% ============================================================
% Lab 3: Điều khiển PID
% ============================================================

\setcounter{section}{3}
\setcounter{subsection}{0}
\section*{BÀI THÍ NGHIỆM 3: ĐIỀU KHIỂN PID}
\addcontentsline{toc}{section}{Bài thí nghiệm 3: Điều khiển PID}

% ------------------------------------------------------------
\subsection{Mục tiêu}
% ------------------------------------------------------------

\begin{itemize}
    \item Hiểu nguyên lý hoạt động của bộ điều khiển PID.
    \item Cấu hình và sử dụng khối PID trong TIA Portal.
    \item Chỉnh định thông số PID và đánh giá chất lượng điều khiển.
\end{itemize}

% ------------------------------------------------------------
\subsection{Cơ sở lý thuyết}
% ------------------------------------------------------------

\subsubsection{Bộ điều khiển PID}

Bộ điều khiển PID là bộ điều khiển đưa ra tác động điều khiển dựa trên ba thành phần: tỉ lệ (P), tích phân (I) và vi phân (D).

\begin{figure}[H]
\centering
\begin{tikzpicture}[node distance=1.5cm]
    % Input
    \node (input) {$e(t)$};
    
    % P, I, D blocks
    \node[block, right=1.5cm of input, yshift=1.2cm] (P) {$K_P$};
    \node[block, right=1.5cm of input] (I) {$\frac{K_P}{T_I} \int$};
    \node[block, right=1.5cm of input, yshift=-1.2cm] (D) {$K_P \cdot T_D \frac{d}{dt}$};
    
    % Sum
    \node[sum, right=1.5cm of I] (sum) {};
    
    % Output
    \node[right=1cm of sum] (output) {$u(t)$};
    
    % Arrows from input
    \coordinate (split) at ($(input.east)+(0.5,0)$);
    \draw[line] (input) -- (split);
    \draw[arrow] (split) |- (P);
    \draw[arrow] (split) -- (I);
    \draw[arrow] (split) |- (D);
    
    % Arrows to sum
    \draw[arrow] (P) -| (sum);
    \draw[arrow] (I) -- (sum);
    \draw[arrow] (D) -| (sum);
    
    % Output arrow
    \draw[arrow] (sum) -- (output);
    
    % Sum signs
    \node[font=\scriptsize] at ($(sum.north)+(0,0.15)$) [right] {$+$};
    \node[font=\scriptsize] at ($(sum.west)+(-0.15,0)$) [below] {$+$};
    \node[font=\scriptsize] at ($(sum.south)+(0,-0.15)$) [right] {$+$};
\end{tikzpicture}
\caption{Sơ đồ khối bộ điều khiển PID}
\label{fig:pid_block_lab3}
\end{figure}

Công thức tổng quát:
\begin{equation}
u(t) = K_P \left( e(t) + \frac{1}{T_I} \int_0^t e(\tau)d\tau + T_D \frac{de(t)}{dt} \right)
\end{equation}

\subsubsection{Ảnh hưởng của các thông số}

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\textbf{Thay đổi} & \textbf{Thời gian đáp ứng} & \textbf{Độ quá điều chỉnh} & \textbf{Sai lệch tĩnh} & \textbf{Ổn định} \\
\hline
Tăng $K_P$ & Giảm & Tăng & Giảm & Xấu đi \\
\hline
Giảm $T_I$ & Giảm & Tăng & Triệt tiêu & Xấu đi \\
\hline
Tăng $T_D$ & Ít thay đổi & Giảm & Không đổi & Tốt hơn \\
\hline
\end{tabular}
\caption{Ảnh hưởng của các thông số PID}
\end{table}

\subsubsection{Khối PID\_Compact trong TIA Portal}

TIA Portal cung cấp khối \texttt{PID\_Compact} để thực hiện điều khiển PID. Các tham số chính:
\begin{itemize}
    \item \texttt{Setpoint}: Giá trị đặt
    \item \texttt{Input}: Giá trị phản hồi (PV)
    \item \texttt{Output}: Tín hiệu điều khiển
    \item \texttt{Gain} ($K_P$): Hệ số khuếch đại
    \item \texttt{Ti}: Thời gian tích phân
    \item \texttt{Td}: Thời gian vi phân
\end{itemize}

% ------------------------------------------------------------
\subsection{Thiết bị thí nghiệm}
% ------------------------------------------------------------

\begin{itemize}
    \item PLC Siemens S7-1200 CPU 1213C
    \item Module analog input/output
    \item Cảm biến nhiệt độ Pt100
    \item Bộ gia nhiệt (Heater)
    \item Phần mềm TIA Portal V16
\end{itemize}

% ------------------------------------------------------------
\subsection{Quy trình thực hiện}
% ------------------------------------------------------------

\subsubsection{Cấu hình khối PID\_Compact}
\begin{enumerate}
    \item Thêm khối \texttt{PID\_Compact} vào chương trình.
    \item Cấu hình các tham số đầu vào/ra.
    \item Thiết lập giới hạn Output (0-100\%).
    \item Kết nối Setpoint và Input với biến tương ứng.
\end{enumerate}

\subsubsection{Chỉnh định thông số PID theo phương pháp Ziegler-Nichols (phương pháp 2 - dao động tới hạn)}

Sử dụng dữ liệu từ thí nghiệm điều khiển ON/OFF (Bài 2) để tính toán thông số PID theo phương pháp Ziegler-Nichols (relay method):

\textbf{Bước 1: Xác định các thông số từ thí nghiệm ON/OFF}
\begin{itemize}
    \item Chu kỳ dao động tới hạn: $T_u = 250$s (từ Bài thí nghiệm 2)
    \item Biên độ dao động: $a = 6.5^\circ$C
    \item Biên độ relay: $d = 50\%$ (relay dao động giữa 0\% và 100\%, biên độ từ tâm = 50\%)
\end{itemize}

\textbf{Bước 2: Tính Ultimate Gain}
\begin{equation}
K_u = \frac{4d}{\pi a} = \frac{4 \times 50}{\pi \times 6.5} \approx 9.8
\end{equation}

\textbf{Bước 3: Tính thông số PID theo công thức Ziegler-Nichols}
\begin{align}
K_P &= 0.6 \times K_u = 0.6 \times 9.8 \approx 5.9 \\
T_i &= \frac{T_u}{2} = \frac{250}{2} = 125 \text{ s} \\
T_d &= \frac{T_u}{8} = \frac{250}{8} = 31.25 \approx 31 \text{ s}
\end{align}

\textbf{Bộ thông số PID được sử dụng:} $K_P = 5.9$, $T_i = 125$s, $T_d = 31$s

\subsubsection{Khảo sát ảnh hưởng của thông số}
\begin{enumerate}
    \item Thay đổi $K_P$ và quan sát đáp ứng.
    \item Thay đổi $T_i$ và quan sát đáp ứng.
    \item Thay đổi $T_d$ và quan sát đáp ứng.
    \item Ghi nhận các chỉ tiêu chất lượng.
\end{enumerate}

% ------------------------------------------------------------
\subsection{Kết quả thí nghiệm}
% ------------------------------------------------------------

\subsubsection{Giao diện HMI}

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{../assets/HMI_TN3.jpg}
\caption{Giao diện HMI thí nghiệm điều khiển PID}
\label{fig:hmi_tn3}
\end{figure}

\subsubsection{Đáp ứng điều khiển PID}

Thí nghiệm điều khiển PID với bộ thông số $K_P = 5.9$, $T_i = 125$s, $T_d = 31$s. Hệ thống được gia nhiệt đến SV = $40^\circ$C, sau đó thực hiện thay đổi bước (step change) lên SV = $50^\circ$C để đánh giá chất lượng điều khiển.

\begin{figure}[H]
\centering
\begin{tikzpicture}
\begin{axis}[
    width=0.9\textwidth,
    height=8cm,
    xlabel={Thời gian (s)},
    ylabel={Nhiệt độ ($^\circ$C)},
    grid=both,
    grid style={line width=.1pt, draw=gray!30},
    major grid style={line width=.2pt,draw=gray!50},
    xmin=0, xmax=1600,
    ymin=20, ymax=55,
    legend pos=south east,
]
\addplot[blue, thick] table[x=time_s, y=PV, col sep=comma] {../data/TN3_processed.csv};
\addlegendentry{PV (Nhiệt độ đo được)}
\addplot[red, dashed, thick] table[x=time_s, y=SV, col sep=comma] {../data/TN3_processed.csv};
\addlegendentry{SV (Giá trị đặt)}

% Đánh dấu thời điểm thay đổi setpoint
\draw[gray, dashed] (axis cs:1054,20) -- (axis cs:1054,55);
\node[font=\small] at (axis cs:1054,22) [right] {Step change};

% Đánh dấu thông số PID
\node[font=\small, fill=white] at (axis cs:500,52) {$K_P=5.9$, $T_i=125$s, $T_d=31$s};
\end{axis}
\end{tikzpicture}
\caption{Đáp ứng điều khiển PID với thay đổi bước setpoint ($40^\circ$C $\rightarrow$ $50^\circ$C)}
\label{fig:pid_response_tn3}
\end{figure}

Phân tích đáp ứng:
\begin{itemize}
    \item \textbf{Giai đoạn 1 (0-1049s):} Gia nhiệt từ nhiệt độ môi trường ($22.8^\circ$C) đến SV = $40^\circ$C
    \begin{itemize}
        \item Thời gian đạt setpoint: 180s
        \item Độ quá điều chỉnh: $2.09^\circ$C (12.2\%)
        \item Thời gian xác lập ($\pm 2\%$): 606s
        \item Sai lệch tĩnh: $\approx 0^\circ$C
    \end{itemize}
    \item \textbf{Giai đoạn 2 (1054-1556s):} Thay đổi bước từ SV = $40^\circ$C lên SV = $50^\circ$C
    \begin{itemize}
        \item Thời gian tăng (rise time): 466s
        \item Độ quá điều chỉnh: $0.37^\circ$C (3.7\%)
        \item Thời gian xác lập ($\pm 2\%$): 231s
        \item Sai lệch tĩnh: $0.14^\circ$C
    \end{itemize}
\end{itemize}

\subsubsection{Kết quả chỉnh định PID}

Bộ thông số PID được sử dụng trong thí nghiệm:

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Thông số} & \textbf{Giá trị} & \textbf{Đơn vị} & \textbf{Ghi chú} \\
\hline
$K_P$ & 5.9 & -- & Hệ số khuếch đại \\
\hline
$T_i$ & 125 & s & Thời gian tích phân \\
\hline
$T_d$ & 31 & s & Thời gian vi phân \\
\hline
\end{tabular}
\caption{Thông số PID sử dụng trong thí nghiệm}
\end{table}

\subsubsection{Chỉ tiêu chất lượng điều khiển}

\begin{table}[H]
\centering
\begin{tabular}{|l|c|c|}
\hline
\textbf{Chỉ tiêu} & \textbf{Giai đoạn 1} & \textbf{Giai đoạn 2} \\
 & (SV = $40^\circ$C) & (Step: $40 \rightarrow 50^\circ$C) \\
\hline
Thời gian đạt setpoint & 180s & 466s \\
\hline
Độ quá điều chỉnh & 12.2\% ($2.09^\circ$C) & 3.7\% ($0.37^\circ$C) \\
\hline
Thời gian xác lập ($\pm 2\%$) & 606s & 231s \\
\hline
Sai lệch tĩnh & $\approx 0^\circ$C & $0.14^\circ$C \\
\hline
\end{tabular}
\caption{Chỉ tiêu chất lượng điều khiển PID}
\end{table}

\subsubsection{Đánh giá hiệu suất tổng thể}

\begin{table}[H]
\centering
\begin{tabular}{|l|c|}
\hline
\textbf{Chỉ tiêu} & \textbf{Giá trị} \\
\hline
Sai số trung bình tuyệt đối (MAE) & $2.22^\circ$C \\
\hline
Sai số tối đa & $17.16^\circ$C \\
\hline
MAE trạng thái xác lập & $0.12^\circ$C \\
\hline
\end{tabular}
\caption{Đánh giá hiệu suất tổng thể}
\end{table}

% ------------------------------------------------------------
\subsection{Bàn luận}
% ------------------------------------------------------------

\subsubsection{Phân tích kết quả điều khiển}

Bộ thông số PID ($K_P = 5.9$, $T_i = 125$s, $T_d = 31$s) cho kết quả:

\begin{itemize}
    \item \textbf{Hệ số khuếch đại $K_P = 5.9$:} Đúng theo công thức Ziegler-Nichols ($0.6 \times K_u$). Độ quá điều chỉnh 12.2\% trong giai đoạn khởi động là chấp nhận được.
    
    \item \textbf{Thời gian tích phân $T_i = 125$s:} Đúng theo công thức $T_u/2$, giúp triệt tiêu sai lệch tĩnh hiệu quả (sai lệch tĩnh $\approx 0^\circ$C).
    
    \item \textbf{Thời gian vi phân $T_d = 31$s:} Đúng theo công thức $T_u/8$, giúp giảm độ quá điều chỉnh trong giai đoạn step change xuống còn 3.7\%.
\end{itemize}

\subsubsection{So sánh với điều khiển ON/OFF (Bài 2)}

\begin{table}[H]
\centering
\begin{tabular}{|l|c|c|}
\hline
\textbf{Tiêu chí} & \textbf{ON/OFF (Bài 2)} & \textbf{PID (Bài 3)} \\
\hline
Biên độ dao động & $\pm 6.5^\circ$C & $< 0.5^\circ$C (xác lập) \\
\hline
Độ quá điều chỉnh & 50\% ($5.5^\circ$C) & 12.2\% ($2.09^\circ$C) \\
\hline
Sai lệch tĩnh & Dao động liên tục & $\approx 0^\circ$C \\
\hline
Chu kỳ dao động & 250s & Không dao động \\
\hline
Chất lượng điều khiển & Thấp & Cao \\
\hline
\end{tabular}
\caption{So sánh điều khiển ON/OFF và PID}
\end{table}

\textbf{Nhận xét:}
\begin{itemize}
    \item Điều khiển PID cải thiện đáng kể chất lượng so với ON/OFF: giảm biên độ dao động từ $\pm 6.5^\circ$C xuống gần như bằng 0 trong trạng thái xác lập
    \item PID triệt tiêu hoàn toàn sai lệch tĩnh, trong khi ON/OFF luôn dao động quanh setpoint
    \item Thông số PID tính từ dữ liệu ON/OFF theo Ziegler-Nichols cho kết quả tốt, xác nhận tính hiệu quả của phương pháp
\end{itemize}

\subsubsection{Đánh giá chất lượng điều khiển}

\begin{itemize}
    \item \textbf{Độ quá điều chỉnh:} Giai đoạn khởi động có độ quá điều chỉnh 12.2\% (chấp nhận được cho hệ thống nhiệt). Giai đoạn step change có độ quá điều chỉnh thấp hơn (3.7\%), cho thấy bộ điều khiển hoạt động tốt hơn khi hệ thống đã ổn định.
    
    \item \textbf{Thời gian xác lập:} 606s cho giai đoạn khởi động và 231s cho step change. Thời gian này phù hợp với đặc tính của hệ thống nhiệt có quán tính lớn.
    
    \item \textbf{Sai lệch tĩnh:} Gần như bằng 0 trong cả hai giai đoạn ($<0.15^\circ$C), cho thấy thành phần tích phân hoạt động hiệu quả.
    
    \item \textbf{Độ ổn định:} Hệ thống ổn định, không có dao động kéo dài. Đáp ứng mượt mà và không có hiện tượng mất ổn định.
\end{itemize}

% ------------------------------------------------------------
\subsection{Kết luận}
% ------------------------------------------------------------

Qua thí nghiệm điều khiển PID hệ thống gia nhiệt, rút ra các kết luận sau:

\begin{enumerate}
    \item \textbf{Phương pháp chỉnh định:} Thông số PID được tính toán theo phương pháp Ziegler-Nichols relay, sử dụng dữ liệu từ thí nghiệm ON/OFF (Bài 2):
    \begin{itemize}
        \item Chu kỳ dao động $T_u = 250$s, biên độ $a = 6.5^\circ$C, biên độ relay $d = 50\%$
        \item Ultimate gain $K_u = 4d/(\pi a) = 9.8$
        \item $K_P = 0.6 K_u = 5.9$, $T_i = T_u/2 = 125$s, $T_d = T_u/8 = 31$s
    \end{itemize}
    
    \item \textbf{Kết quả điều khiển giai đoạn khởi động (SV = $40^\circ$C):}
    \begin{itemize}
        \item Thời gian đạt setpoint: 180s
        \item Độ quá điều chỉnh: 12.2\% ($2.09^\circ$C)
        \item Thời gian xác lập: 606s
        \item Sai lệch tĩnh: $\approx 0^\circ$C
    \end{itemize}
    
    \item \textbf{Kết quả điều khiển khi thay đổi bước ($40 \rightarrow 50^\circ$C):}
    \begin{itemize}
        \item Thời gian tăng: 466s
        \item Độ quá điều chỉnh: 3.7\% ($0.37^\circ$C)
        \item Thời gian xác lập: 231s
        \item Sai lệch tĩnh: $0.14^\circ$C
    \end{itemize}
    
    \item \textbf{So sánh với ON/OFF:} Điều khiển PID cải thiện đáng kể so với ON/OFF:
    \begin{itemize}
        \item Giảm biên độ dao động từ $\pm 6.5^\circ$C xuống $< 0.5^\circ$C
        \item Triệt tiêu sai lệch tĩnh (từ dao động liên tục xuống $\approx 0^\circ$C)
        \item Hệ thống ổn định, không có chu kỳ dao động
    \end{itemize}
    
    \item \textbf{Kết luận:} Phương pháp Ziegler-Nichols relay cho phép tính toán thông số PID hiệu quả từ dữ liệu thí nghiệm ON/OFF, không cần sử dụng Auto-tuning.
\end{enumerate}

% ------------------------------------------------------------
\subsection{Câu hỏi kiểm tra}
% ------------------------------------------------------------

\textbf{Câu 1: Trình bày các bước chỉnh định PID theo phương pháp Ziegler-Nichols?}

Phương pháp Ziegler-Nichols (phương pháp dao động tới hạn):
\begin{enumerate}
    \item Đặt $T_i = \infty$ (tắt thành phần I), $T_d = 0$ (tắt thành phần D)
    \item Tăng dần $K_P$ từ 0 cho đến khi hệ thống bắt đầu dao động điều hòa với biên độ không đổi
    \item Ghi nhận giá trị $K_P$ tới hạn ($K_u$) và chu kỳ dao động ($T_u$)
    \item Tính toán thông số PID theo bảng Ziegler-Nichols:
    \begin{itemize}
        \item Bộ P: $K_P = 0.5 K_u$
        \item Bộ PI: $K_P = 0.45 K_u$, $T_i = T_u/1.2$
        \item Bộ PID: $K_P = 0.6 K_u$, $T_i = T_u/2$, $T_d = T_u/8$
    \end{itemize}
\end{enumerate}

\textbf{Câu 2: Giải thích ý nghĩa của thời gian tích phân $T_i$ và thời gian vi phân $T_d$?}

\begin{itemize}
    \item \textbf{Thời gian tích phân $T_i$:} Là thời gian cần thiết để thành phần tích phân tạo ra tác động điều khiển bằng với thành phần tỉ lệ khi sai lệch không đổi. $T_i$ nhỏ làm tác động tích phân mạnh hơn, giúp triệt tiêu sai lệch tĩnh nhanh hơn nhưng có thể gây mất ổn định.
    
    \item \textbf{Thời gian vi phân $T_d$:} Là thời gian dự đoán (prediction time) của thành phần vi phân, thể hiện khả năng phản ứng với tốc độ thay đổi của sai lệch. $T_d$ lớn làm tác động vi phân mạnh hơn, giúp giảm độ quá điều chỉnh và cải thiện độ ổn định.
\end{itemize}

\textbf{Câu 3: Khi nào nên sử dụng bộ điều khiển P, PI, hay PID?}

\begin{itemize}
    \item \textbf{Bộ P:} Sử dụng khi chấp nhận được sai lệch tĩnh và cần đáp ứng đơn giản, nhanh. Ví dụ: điều khiển mức nước trong bể chứa lớn.
    
    \item \textbf{Bộ PI:} Sử dụng khi cần triệt tiêu sai lệch tĩnh và hệ thống không quá nhạy với nhiễu. Ví dụ: điều khiển lưu lượng, điều khiển áp suất.
    
    \item \textbf{Bộ PID:} Sử dụng cho các hệ thống cần độ chính xác cao, cần triệt tiêu sai lệch tĩnh và giảm độ quá điều chỉnh. Ví dụ: điều khiển nhiệt độ, điều khiển vị trí servo, các quy trình công nghiệp yêu cầu cao.
\end{itemize}

% ------------------------------------------------------------
\subsection{Tài liệu tham khảo}
% ------------------------------------------------------------

\begin{enumerate}[label={[\arabic*]}]
    \item B. N. Pha, \textit{Thiết bị Đo lường và Điều khiển}. Trường Đại học Bách khoa, ĐHQG-HCM.
    \item Siemens, \textit{S7-1200 Programmable Controller System Manual}. Siemens AG, 2020.
    \item Siemens, \textit{PID Control with SIMATIC S7-1200}. Siemens AG, 2019.
\end{enumerate}

\newpage
